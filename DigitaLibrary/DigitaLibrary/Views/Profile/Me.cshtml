@model DigitaLibrary.ViewModels.ProfilePageViewModel
@using System.Linq
@{
    ViewData["Title"] = "Profilim";

    var avatar = string.IsNullOrWhiteSpace(Model.User?.AvatarPath)
        ? Url.Content("~/img/avatar-placeholder.png")
        : Url.Content(Model.User!.AvatarPath);

    // Hızlı sayaçlar (status/flag yoksa güvenli varsayımlar)
    var total = Model.MyPosts?.Count() ?? 0;
    var approved = 0;  // İleride gerçek kolona bağlayacağız
    var rejected = 0;  // İleride gerçek kolona bağlayacağız
}

@section Styles {
    <style>
        :root {
            --brand: #6a11cb;
            --brand-2: #2575fc;
            --soft: #f8f9fa;
        }

        .profile-wrap {
            max-width: 1100px;
            margin-inline: auto
        }

        .profile-cover {
            background: linear-gradient(90deg,var(--brand),var(--brand-2));
            min-height: 180px;
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }

        .cover-actions {
            position: absolute;
            right: 16px;
            top: 16px;
            z-index: 2
        }

        .profile-avatar {
            width: 132px;
            height: 132px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #fff;
            position: absolute;
            left: 28px;
            bottom: -66px;
            z-index: 2;
            box-shadow: 0 10px 30px rgba(0,0,0,.2)
        }

        .profile-head {
            margin-top: 88px
        }

        .stat-chip {
            background: var(--soft);
            border: 1px solid #eee;
            border-radius: 12px;
            padding: .75rem 1rem;
            min-width: 180px
        }

            .stat-chip .value {
                font-weight: 700;
                font-size: 1.15rem
            }

        .tab-buttons .nav-link {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            margin-right: .5rem;
            color: #444;
            padding: .55rem 1rem
        }

            .tab-buttons .nav-link.active {
                border-color: var(--brand);
                color: var(--brand);
                font-weight: 700;
                background: rgba(106,17,203,.06)
            }

        .item-card {
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 1rem
        }

        .empty {
            border: 1px dashed #e2e8f0;
            border-radius: 12px;
            padding: 1.25rem;
            color: #6c757d
        }
       
        @@media (max-width:576px) {
            .profile-avatar

        {
            left: 50%;
            transform: translateX(-50%);
            bottom: -66px
        }

        .profile-head {
            margin-top: 90px;
            text-align: center
        }

        }
    </style>
}

<div class="container profile-wrap my-4">

    <!-- Kapak + Avatar -->
    <div class="profile-cover mb-5">
        <div class="cover-actions btn-group">
            <a asp-controller="Profile" asp-action="EditCover" class="btn btn-light btn-sm">
                <i class="bi bi-image"></i> Kapağı Değiştir
            </a>
            <a asp-controller="Profile" asp-action="Edit" class="btn btn-primary btn-sm">
                <i class="bi bi-pencil-square"></i> Profili Düzenle
            </a>
        </div>
        <img src="@avatar" alt="Avatar" class="profile-avatar" />
    </div>

    <!-- Başlık + İstatistik -->
    <div class="profile-head">
        <div class="d-flex flex-column flex-sm-row align-items-sm-center justify-content-sm-between gap-2">
            <div>
                <h3 class="mb-1">@Model.User?.UserName</h3>
                <div class="text-muted">@Model.User?.Email</div>
            </div>
            <div class="d-flex gap-3">
                <div class="stat-chip text-center">
                    <div class="value">@approved</div>
                    <div class="text-muted small">Onaylanan Madde</div>
                </div>
                <div class="stat-chip text-center">
                    <div class="value">@rejected</div>
                    <div class="text-muted small">Reddedilen Madde</div>
                </div>
                <div class="stat-chip text-center">
                    <div class="value">@total</div>
                    <div class="text-muted small">Toplam Paylaşım</div>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-4" />

    <!-- Sekmeler -->
    <ul class="nav tab-buttons mb-3" id="profileTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info"
                    type="button" role="tab" aria-controls="info" aria-selected="true">
                <i class="bi bi-person-badge"></i> Kullanıcı Bilgileri
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="myitems-tab" data-bs-toggle="tab" data-bs-target="#myitems"
                    type="button" role="tab" aria-controls="myitems" aria-selected="false">
                <i class="bi bi-journal-text"></i> Maddelerim
                @if (total > 0)
                {
                    <span class="badge bg-secondary ms-1">@total</span>
                }
            </button>
        </li>
        <li class="ms-auto">
            <a class="btn btn-primary" asp-controller="Posts" asp-action="Create">
                <i class="bi bi-plus-circle"></i> Makale Ekle
            </a>
        </li>
    </ul>

    <!-- İçerikler -->
    <div class="tab-content" id="profileTabsContent">
        <!-- Kullanıcı Bilgileri -->
        <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab" tabindex="0">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="form-floating">
                        <input class="form-control" value="@Model.User?.UserName" readonly>
                        <label>Kullanıcı Adı</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        <input class="form-control" value="@Model.User?.Email" readonly>
                        <label>E-posta</label>
                    </div>
                </div>
            </div>

            <div class="mt-3">
                <label class="form-label">Biyografi</label>
                <textarea class="form-control" rows="3" readonly>Henüz biyografi girilmemiş.</textarea>
            </div>

            <div class="mt-3 d-flex gap-2">
                <a asp-controller="Profile" asp-action="Edit" class="btn btn-outline-primary">
                    <i class="bi bi-pencil"></i> Bilgileri Güncelle
                </a>
                <a asp-controller="Account" asp-action="ChangePassword" class="btn btn-outline-secondary">
                    <i class="bi bi-shield-lock"></i> Şifre Değiştir
                </a>
            </div>
        </div>

        <!-- Maddelerim -->
        <div class="tab-pane fade" id="myitems" role="tabpanel" aria-labelledby="myitems-tab" tabindex="0">
            @if (Model.MyPosts != null && Model.MyPosts.Any())
            {
                <div class="row g-3">
                    @foreach (var p in Model.MyPosts)
                    {
                        <div class="col-md-6">
                            <div class="item-card d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fw-semibold">@p.Title</div>
                                    <div class="text-muted small">
                                        <i class="bi bi-calendar2"></i>
                                        @p.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy")
                                    </div>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <a asp-controller="Posts" asp-action="Details" asp-route-id="@p.Id" class="btn btn-outline-primary">Görüntüle</a>
                                    <a asp-controller="Posts" asp-action="Edit" asp-route-id="@p.Id" class="btn btn-outline-secondary">Düzenle</a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="empty d-flex justify-content-between align-items-center">
                    <span>Henüz paylaşım yok.</span>
                    <a asp-controller="Posts" asp-action="Create" class="btn btn-primary btn-sm">İlkini Ekle</a>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Sekme durumunu URL hash ile koru
        (function(){
            var hash = window.location.hash;
            if (hash) {
                var el = document.querySelector('[data-bs-target="'+hash+'"]');
                if (el) new bootstrap.Tab(el).show();
            }
            document.querySelectorAll('#profileTabs [data-bs-toggle="tab"]').forEach(function(el){
                el.addEventListener('shown.bs.tab', function (e) {
                    history.replaceState(null, "", e.target.getAttribute('data-bs-target'));
                });
            });
        })();
    </script>
}
