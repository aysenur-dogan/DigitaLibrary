@model DigitaLibrary.ViewModels.ProfilePageViewModel
@using System.Linq

@{
    ViewData["Title"] = "Profilim";
    var cover = string.IsNullOrWhiteSpace(Model.User?.CoverPath)
        ? ""
        : Url.Content(Model.User!.CoverPath);

    var avatar = string.IsNullOrWhiteSpace(Model.User?.AvatarPath)
        ? Url.Content("~/images/defaults/avatar.png")
        : Url.Content(Model.User!.AvatarPath);

    var display = string.IsNullOrWhiteSpace(Model.User?.DisplayName)
        ? Model.User?.Email
        : Model.User!.DisplayName;

    var total = Model.TotalPosts;
    var approved = Model.PublishedPosts;
    var rejected = Model.DraftPosts;

    // İsim / Soyisim: Önce doğrudan property, yoksa DisplayName'i parçala
    var firstName = (Model.User?.FirstName ?? "").Trim();
    var lastName = (Model.User?.LastName ?? "").Trim();
    if (string.IsNullOrWhiteSpace(firstName) && string.IsNullOrWhiteSpace(lastName))
    {
        var parts = (Model.User?.DisplayName ?? "").Trim()
                     .Split(' ', 2, StringSplitOptions.RemoveEmptyEntries);
        firstName = parts.ElementAtOrDefault(0) ?? "";
        lastName = parts.ElementAtOrDefault(1) ?? "";
    }

    // Yeni: Akademik çalışma sayısı (sekmede badge için)
    var worksCount = Model.MyWorks?.Count() ?? 0;
}

@section Styles {
    <style>
        html, body {
            overflow-x: hidden;
        }

        .page-bg {
            min-height: 100vh;
            background: linear-gradient(180deg,#f8fafc 0%, #eef2ff 100%);
            padding-bottom: 48px;
        }

        .profile-cover {
            width: 100vw;
            margin-left: calc(-50vw + 50%);
            height: 220px;
            position: relative;
            border-radius: 0;
            box-shadow: none;
            z-index: 0;
            background: linear-gradient(90deg,#6366f1 0%, #8b5cf6 50%, #06b6d4 100%);
        }

            .profile-cover.has-cover {
                background: center / cover no-repeat;
            }

                .profile-cover.has-cover::after {
                    content: "";
                    position: absolute;
                    inset: 0;
                    background: linear-gradient(0deg, rgba(0,0,0,.15), rgba(0,0,0,.15));
                }

        .cover-inner {
            height: 100%;
            max-width: 1100px;
            margin: 0 auto;
            position: relative;
        }

        .cover-actions {
            position: absolute;
            right: 16px;
            top: 16px;
            display: flex;
            gap: 8px;
            z-index: 2;
        }

        .profile-avatar {
            width: 160px;
            height: 160px;
            object-fit: cover;
            border-radius: 50%;
            border: 6px solid #fff;
            box-shadow: 0 0 0 5px #6366f1;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: -80px;
            z-index: 10;
        }

        .auth-card {
            width: 100%;
            max-width: 1100px;
            margin: 130px auto 0 auto;
            background: #fff;
            border: 1px solid rgba(2,6,23,.06);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(2,6,23,.06), 0 2px 8px rgba(2,6,23,.05);
            position: relative;
            z-index: 1;
            overflow: visible;
        }

        .heading {
            padding: 16px 24px 0 24px;
        }

        .stats {
            display: flex;
            gap: .5rem;
        }

        .stat {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: .75rem 1rem;
            min-width: 160px;
            text-align: center;
        }

            .stat .val {
                font-weight: 800;
                font-size: 1.1rem;
                color: #0f172a;
            }

            .stat .lbl {
                font-size: .78rem;
                color: #64748b;
            }

        .tab-buttons .nav-link {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: .55rem 1rem;
            color: #334155;
            margin-right: .5rem;
            background: #fff;
        }

            .tab-buttons .nav-link.active {
                border-color: #6366f1;
                color: #4338ca;
                font-weight: 700;
                background: #eef2ff;
            }

        .section {
            padding: 16px 24px 24px 24px;
        }

        .item-card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1rem;
            background: #fff;
        }

        .empty {
            border: 1px dashed #cbd5e1;
            border-radius: 12px;
            padding: 1rem;
            color: #64748b;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bio-display {
            white-space: pre-wrap;
            word-break: break-word;
        }

        .chip {
            display: inline-block;
            padding: .35rem .75rem;
            border: 1px solid #e5e7eb;
            border-radius: 9999px;
            background: #f3f4f6;
            font-size: .875rem;
            color: #374151;
        }

        .chip-block {
            display: block;
            border-radius: 12px;
            white-space: normal;
            line-height: 1.45;
        }

        .chip-row {
            display: flex;
            flex-wrap: wrap;
            gap: .5rem;
            align-items: center;
        }

        .section-title {
            font-weight: 600;
            color: #111827;
        }

        .muted {
            color: #6b7280;
        }

        /* Akademik çalışma kartları */
        .work-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-top-left-radius: .5rem;
            border-top-right-radius: .5rem;
        }

        .work-card .title {
            font-weight: 600;
            color: #0f172a;
        }

        .work-card a {
            text-decoration: none;
            color: inherit;
        }

        .work-card .meta {
            color: #6b7280;
            font-size: .85rem;
        }

        @@media (max-width: 576px) {
            .profile-cover

        {
            height: 180px;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            bottom: -60px;
        }

        .stats {
            flex-direction: column;
            gap: .5rem;
        }

        }
    </style>
}

<main class="page-bg">
    <div class="profile-cover@(string.IsNullOrEmpty(cover) ? "" : " has-cover")"
         style="@(string.IsNullOrEmpty(cover) ? "" : $"background-image:url('{cover}');")">
        <div class="cover-inner">
            <div class="cover-actions">
                <a asp-controller="Profile" asp-action="Edit" class="btn btn-primary btn-sm">
                    <i class="bi bi-pencil-square"></i> Profili Düzenle
                </a>
            </div>
            <img src="@avatar" alt="Avatar" class="profile-avatar" />
        </div>
    </div>

    <div class="auth-card">
        <div class="heading">
            <div class="d-flex flex-column flex-md-row align-items-md-end justify-content-between gap-3">
                <div>
                    <h1 class="h3 mb-1 fw-bold text-dark">@display</h1>
                    <div class="text-muted">@Model.User?.Email</div>
                </div>

                <div class="stats">
                    <div class="stat"><div class="val">@approved</div><div class="lbl">Yayındaki Paylaşım</div></div>
                    <div class="stat"><div class="val">@rejected</div><div class="lbl">Taslak</div></div>
                    <div class="stat"><div class="val">@total</div><div class="lbl">Toplam</div></div>
                </div>
            </div>
        </div>

        <hr class="mt-3 mb-0" />

        <div class="section">
            <ul class="nav tab-buttons align-items-center" id="profileTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info"
                            type="button" role="tab" aria-controls="info" aria-selected="true">
                        <i class="bi bi-person-badge"></i> Kullanıcı Bilgileri
                    </button>
                </li>

                <!-- SEKME: Akademik Çalışmalarım (Model.MyWorks) -->
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="myitems-tab" data-bs-toggle="tab" data-bs-target="#myitems"
                            type="button" role="tab" aria-controls="myitems" aria-selected="false">
                        <i class="bi bi-journal-text"></i> Akademik Çalışmalarım
                        @if (worksCount > 0)
                        {
                            <span class="badge bg-secondary ms-1">@worksCount</span>
                        }
                    </button>
                </li>

                <li class="ms-auto">
                    <a class="btn btn-primary"
                       asp-controller="AcademicWorks"
                       asp-action="Create">
                        <i class="bi bi-plus-circle me-1"></i> Makale Ekle
                    </a>
                </li>
            </ul>

            <div class="tab-content mt-3" id="profileTabsContent">
                <!-- Bilgiler -->
                <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab" tabindex="0">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="section-title mb-2">İsim</div>
                            <div class="chip-row"><span class="chip">@firstName</span></div>
                        </div>
                        <div class="col-md-6">
                            <div class="section-title mb-2">Soyisim</div>
                            <div class="chip-row"><span class="chip">@lastName</span></div>
                        </div>
                    </div>

                    <div class="row g-4 mt-1">
                        <div class="col-12">
                            <div class="section-title mb-2">E-posta</div>
                            <div class="chip-row"><span class="chip">@Model.User?.Email</span></div>
                        </div>
                    </div>

                    @{
                        var interests = (Model.User?.Interests ?? "")
                        .Split(',', StringSplitOptions.RemoveEmptyEntries)
                        .Select(t => t.Trim())
                        .Where(t => t.Length > 0)
                        .ToList();
                    }

                    <div class="row g-4 mt-2">
                        <div class="col-12 col-md-6">
                            <div class="section-title mb-2">Eğitim Bilgileri</div>
                            @if (!string.IsNullOrWhiteSpace(Model.User?.EducationInfo))
                            {
                                <span class="chip">@Model.User.EducationInfo</span>
                            }
                            else
                            {
                                <div class="muted">Bilgi eklenmemiş.</div>
                            }
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="section-title mb-2">İlgi Alanları</div>
                            @if (interests.Any())
                            {
                                <div class="d-flex flex-wrap gap-2">
                                    @foreach (var tag in interests)
                                    {
                                        <span class="chip">@tag</span>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="muted">Bilgi eklenmemiş.</div>
                            }
                        </div>
                    </div>

                    <div class="mb-3 mt-3">
                        <div class="section-title mb-2">Biyografi</div>
                        @if (!string.IsNullOrWhiteSpace(Model.User?.Bio))
                        {
                            <div class="chip chip-block">@Model.User!.Bio</div>
                        }
                        else
                        {
                            <div class="muted">Kullanıcı biyografisi girilmemiştir.</div>
                        }
                    </div>

                    <div class="mt-3 d-flex gap-2">
                        <a asp-controller="Profile" asp-action="Edit" class="btn btn-outline-primary">
                            <i class="bi bi-pencil"></i> Bilgileri Güncelle
                        </a>
                        <a asp-controller="Account" asp-action="ChangePassword" class="btn btn-outline-secondary">
                            <i class="bi bi-shield-lock"></i> Şifre Değiştir
                        </a>
                    </div>
                </div>

                <!-- SEKME: Akademik Çalışmalarım (kart grid) -->
                <div class="tab-pane fade" id="myitems" role="tabpanel" aria-labelledby="myitems-tab" tabindex="0">
                    @if (Model.MyWorks != null && Model.MyWorks.Any())
                    {
                        <div class="row g-3">
                            @foreach (var w in Model.MyWorks)
                            {
                                <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
                                    <div class="card shadow-sm h-100 work-card">
                                        <a asp-controller="AcademicWorks" asp-action="Details" asp-route-slug="@w.Slug">
                                            <img src="@(string.IsNullOrWhiteSpace(w.CoverImagePath)
                                                                                                         ? Url.Content("~/images/placeholders/cover-400x250.png")
                                                                                                         : Url.Content(w.CoverImagePath))"
                                         alt="@w.Title" />
                                    <div class="card-body">
                                        <div class="title">@w.Title</div>
                                        @if (!string.IsNullOrWhiteSpace(w.Authors))
                                                {
                                                    <div class="meta mt-1">@w.Authors</div>
                                                }
                                                <div class="meta">@w.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy")</div>
                                            </div>
                                        </a>
                                    </div>
                                </div>
                            }
                        </div>
                        <div class="mt-3">
                            <a class="btn btn-outline-primary" asp-controller="Profile" asp-action="MyWorks">Tümünü Gör</a>
                        </div>
                    }
                    else
                    {
                        <div class="empty">
                            <span>Henüz akademik çalışma yok.</span>
                            <a asp-controller="AcademicWorks" asp-action="Create" class="btn btn-primary btn-sm">İlkini Ekle</a>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="text-center text-muted py-3 border-top">
            <small>© 2025 — MyApp</small>
        </div>
    </div>
</main>

@section Scripts {
    <script>
        (function () {
            var hash = window.location.hash;
            if (hash) {
                var el = document.querySelector('[data-bs-target="' + hash + '"]');
                if (el) new bootstrap.Tab(el).show();
            }
            document.querySelectorAll('#profileTabs [data-bs-toggle="tab"]').forEach(function (el) {
                el.addEventListener('shown.bs.tab', function (e) {
                    history.replaceState(null, "", e.target.getAttribute('data-bs-target'));
                });
            });
        })();
    </script>
}
