@model DigitaLibrary.ViewModels.ProfilePageViewModel
@using System.Linq
@{
    ViewData["Title"] = "Profilim";

    var avatar = string.IsNullOrWhiteSpace(Model.User?.AvatarPath)
        ? Url.Content("~/img/avatar-placeholder.png")
        : Url.Content(Model.User!.AvatarPath);

    var total = Model.MyPosts?.Count() ?? 0;
    var approved = 0;  // TODO: gerçek kolonlara bağlanabilir
    var rejected = 0;  // TODO: gerçek kolonlara bağlanabilir
}

@section Styles {
    <style>
        /* Sayfada yatay scroll oluşmaması için */
        .auth-bg {
            background: linear-gradient(180deg,#f8fafc 0%,#eef2ff 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* TAM EKRAN KAPAK — karttan bağımsız */
        .profile-cover {
            position: relative;
            height: 220px;
            /* container'dan TAM EKRAN'a taşır: */
            width: 100vw;
            margin-left: calc(-50vw + 50%); /* full-bleed hilesi */
            background: linear-gradient(90deg,#6366f1 0%, #8b5cf6 50%, #06b6d4 100%);
            border-radius: 0; /* köşe kesilmelerini önle */
            box-shadow: none;
            z-index: 0;
        }

        /* Kapak içeriğini ortala (avatar/aksiyonlar bunun içinde) */
        .cover-inner {
            height: 100%;
            max-width: 1100px;
            margin: 0 auto;
            position: relative;
        }

        .cover-actions {
            position: absolute;
            right: 16px;
            top: 16px;
            display: flex;
            gap: 8px;
            z-index: 2;
        }

        .profile-avatar {
            width: 112px;
            height: 112px;
            object-fit: cover;
            border-radius: 50%;
            border: 4px solid #fff;
            box-shadow: 0 10px 24px rgba(2,6,23,.18);
            position: absolute;
            left: 24px;
            bottom: -56px;
            z-index: 3;
        }

        /* Ortadaki kart (kapak DIŞINDA!) */
        .auth-card {
            width: 100%;
            max-width: 1100px;
            margin: 0 auto;
            background: #fff;
            border: 1px solid rgba(2,6,23,.06);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(2,6,23,.06),0 2px 8px rgba(2,6,23,.05);
            overflow: visible;
        }

        .lift-up {
            margin-top: -56px;
        }
        /* avatar kadar yukarı çek */

        /* Diğerleri aynı */
        .heading {
            padding: 16px 24px 0 24px;
        }

        .stat {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: .75rem 1rem;
            min-width: 160px;
            text-align: center;
        }

            .stat .val {
                font-weight: 800;
                font-size: 1.1rem;
                color: #0f172a;
            }

            .stat .lbl {
                font-size: .78rem;
                color: #64748b;
            }

        .tab-buttons .nav-link {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: .55rem 1rem;
            color: #334155;
            margin-right: .5rem;
            background: #fff;
        }

            .tab-buttons .nav-link.active {
                border-color: #6366f1;
                color: #4338ca;
                font-weight: 700;
                background: #eef2ff;
            }

        .section {
            padding: 16px 24px 24px 24px;
        }

        .item-card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1rem;
            background: #fff;
        }

        .empty {
            border: 1px dashed #cbd5e1;
            border-radius: 12px;
            padding: 1rem;
            color: #64748b;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        @@media(max-width:576px) {
            .profile-cover {
                height: 180px;
            }

            .profile-avatar {
                left: 50%;
                transform: translateX(-50%);
            }

            .stats {
                flex-direction: column;
                gap: .5rem;
            }
        }
    </style>
}


<main class="auth-bg">
  <!-- TAM EKRAN KAPAK (kart DIŞI) -->
  <div class="profile-cover">
    <div class="cover-inner">
      <div class="cover-actions">
        <a asp-controller="Profile" asp-action="EditCover" class="btn btn-light btn-sm">
          <i class="bi bi-image"></i> Kapağı Değiştir
        </a>
        <a asp-controller="Profile" asp-action="Edit" class="btn btn-primary btn-sm">
          <i class="bi bi-pencil-square"></i> Profili Düzenle
        </a>
      </div>
      <img src="@avatar" alt="Avatar" class="profile-avatar" />
    </div>
  </div>

  <!-- ORTA KART -->
  <div class="auth-card lift-up">
    <!-- ... (başlık, istatistikler, sekmeler, içerikler) ... -->
  </div>
</main>


    <!-- ORTA KART -->
    <div class="auth-card lift-up">
        <!-- Başlık + İstatistikler -->
        <div class="heading">
            <div class="d-flex flex-column flex-md-row align-items-md-end justify-content-between gap-3">
                <div>
                @{
                    var display = string.IsNullOrWhiteSpace(Model.User?.DisplayName)
                    ? Model.User?.Email           // DisplayName boşsa e-postayı göster
                    : Model.User!.DisplayName;    // varsa DisplayName'i göster
                }
                <h1 class="h3 mb-1 fw-bold text-dark">@display</h1>
                <div class="text-muted">@Model.User?.Email</div>

                </div>

                <div class="d-flex stats gap-2">
                    <div class="stat">
                        <div class="val">@approved</div>
                        <div class="lbl">Onaylanan Madde</div>
                    </div>
                    <div class="stat">
                        <div class="val">@rejected</div>
                        <div class="lbl">Reddedilen Madde</div>
                    </div>
                    <div class="stat">
                        <div class="val">@total</div>
                        <div class="lbl">Toplam Paylaşım</div>
                    </div>
                </div>
            </div>
        </div>

        <hr class="mt-3 mb-0" />

        <!-- Sekmeler -->
        <div class="section">
            <ul class="nav tab-buttons align-items-center" id="profileTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info"
                            type="button" role="tab" aria-controls="info" aria-selected="true">
                        <i class="bi bi-person-badge"></i> Kullanıcı Bilgileri
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="myitems-tab" data-bs-toggle="tab" data-bs-target="#myitems"
                            type="button" role="tab" aria-controls="myitems" aria-selected="false">
                        <i class="bi bi-journal-text"></i> Akademik Çalışmalarım
                        @if (total > 0)
                        {
                            <span class="badge bg-secondary ms-1">@total</span>
                        }
                    </button>
                </li>

                <li class="ms-auto">
                    <a class="btn btn-primary" asp-controller="Posts" asp-action="Create">
                        <i class="bi bi-plus-circle"></i> Makale Ekle
                    </a>
                </li>
            </ul>

            <!-- İçerikler -->
            <div class="tab-content mt-3" id="profileTabsContent">
                <!-- Kullanıcı Bilgileri -->
                <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab" tabindex="0">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input class="form-control" value="@Model.User?.UserName" readonly>
                                <label>Kullanıcı Adı</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input class="form-control" value="@Model.User?.Email" readonly>
                                <label>E-posta</label>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">Biyografi</label>
                        <textarea class="form-control" rows="3" readonly>Henüz biyografi girilmemiş.</textarea>
                    </div>
                @if (Model.IsOwner)
                {
                    <div class="mt-3 d-flex gap-2">
                        <a asp-controller="Profile" asp-action="Edit" class="btn btn-outline-primary">
                            <i class="bi bi-pencil"></i> Bilgileri Güncelle
                        </a>
                        <a asp-controller="Account" asp-action="ChangePassword" class="btn btn-outline-secondary">
                            <i class="bi bi-shield-lock"></i> Şifre Değiştir
                        </a>
                    </div>
                }

                </div>

                <!-- Akademik Çalışmalarım -->
                <div class="tab-pane fade" id="myitems" role="tabpanel" aria-labelledby="myitems-tab" tabindex="0">
                    @if (Model.MyPosts != null && Model.MyPosts.Any())
                    {
                        <div class="row g-3">
                            @foreach (var p in Model.MyPosts)
                            {
                                <div class="col-md-6">
                                    <div class="item-card d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="fw-semibold">@p.Title</div>
                                            <div class="text-muted small">
                                                <i class="bi bi-calendar2"></i>
                                                @p.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy")
                                            </div>
                                        </div>
                                        <div class="btn-group btn-group-sm">
                                            <a asp-controller="Posts" asp-action="Details" asp-route-id="@p.Id" class="btn btn-outline-primary">Görüntüle</a>
                                            <a asp-controller="Posts" asp-action="Edit" asp-route-id="@p.Id" class="btn btn-outline-secondary">Düzenle</a>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="empty">
                            <span>Henüz paylaşım yok.</span>
                            <a asp-controller="Posts" asp-action="Create" class="btn btn-primary btn-sm">İlkini Ekle</a>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Alt telif -->
        <div class="text-center text-muted py-3 border-top">
            <small>© 2025 — MyApp</small>
        </div>
    </div>
</main>

@section Scripts {
    <script>
        // Sekme durumunu URL hash ile koru
        (function () {
            var hash = window.location.hash;
            if (hash) {
                var el = document.querySelector('[data-bs-target="' + hash + '"]');
                if (el) new bootstrap.Tab(el).show();
            }
            document.querySelectorAll('#profileTabs [data-bs-toggle="tab"]').forEach(function (el) {
                el.addEventListener('shown.bs.tab', function (e) {
                    history.replaceState(null, "", e.target.getAttribute('data-bs-target'));
                });
            });
        })();
    </script>
}
